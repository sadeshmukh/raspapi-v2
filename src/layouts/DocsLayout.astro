---
import "../styles/global.css";
import { getCollection } from "astro:content";

interface Props {
  title: string;
  description?: string;
}

const { title, description } = Astro.props;

const guides = await getCollection("guides");

const grouped = guides.reduce(
  (acc, guide) => {
    const parts = guide.id.split("/");
    const category = parts.length > 1 ? parts[0] : "general";
    if (!acc[category]) acc[category] = [];
    acc[category].push(guide);
    return acc;
  },
  {} as Record<string, typeof guides>
);

const sidebarOrder = ["about", "building", "hosting"];
const sortedCategories = sidebarOrder
  .map((cat) => [cat, grouped[cat] || []] as [string, typeof guides])
  .filter(([, items]) => items.length > 0);

for (const [, items] of sortedCategories) {
  items.sort((a, b) => (a.data.order ?? 0) - (b.data.order ?? 0));
}

function formatCategory(cat: string): string {
  if (cat === "about") return "About";
  if (cat === "building") return "Building";
  if (cat === "hosting") return "Hosting";
  return cat
    .split("-")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");
}

const currentPath = Astro.url.pathname;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Syne:wght@700;800&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    {description && <meta name="description" content={description} />}
  </head>
  <body
    class="bg-[#0a0a0a] text-[#e5e5e5] font-['Inter',sans-serif] antialiased"
  >
    <div class="min-h-screen flex flex-col">
      <header
        class="border-b border-[#1a1a1a] sticky top-0 bg-[#0a0a0a]/95 backdrop-blur-sm z-40"
      >
        <div
          class="max-w-6xl mx-auto px-6 h-14 flex items-center justify-between"
        >
          <a
            href="/"
            class="font-['Syne',sans-serif] font-bold text-lg tracking-wide text-white hover:text-[#c41e3a] transition-colors"
          >
            RASPAPI
          </a>
          <nav class="flex items-center gap-6 text-sm">
            <a
              href="/guides"
              class="text-[#a3a3a3] hover:text-white transition-colors"
            >
              Guides
            </a>
            <!-- TODO: actual github link  -->
          </nav>
        </div>
      </header>

      <div class="flex-1 flex">
        <aside class="w-64 shrink-0 border-r border-[#1a1a1a] hidden md:block">
          <nav
            class="sticky top-14 p-6 max-h-[calc(100vh-3.5rem)] overflow-y-auto"
          >
            {
              sortedCategories.map(([category, items]) => (
                <div class="mb-6">
                  <h3 class="text-xs font-medium text-[#737373] uppercase tracking-wider mb-3">
                    {formatCategory(category)}
                  </h3>
                  <ul class="space-y-1">
                    {items.map((guide) => {
                      const href = `/guides/${guide.id}`;
                      const isActive = currentPath === href;
                      return (
                        <li>
                          <a
                            href={href}
                            class:list={[
                              "block py-1.5 px-3 rounded text-sm transition-colors",
                              isActive
                                ? "bg-[#1a1a1a] text-white"
                                : "text-[#a3a3a3] hover:text-white hover:bg-[#141414]",
                            ]}
                          >
                            {guide.data.title}
                          </a>
                        </li>
                      );
                    })}
                  </ul>
                </div>
              ))
            }
          </nav>
        </aside>

        <main class="flex-1 min-w-0">
          <article class="max-w-3xl mx-auto px-6 py-12">
            <slot />
          </article>
        </main>
      </div>
    </div>
  </body>
</html>

<style is:global>
  @reference "tailwindcss";

  .prose {
    @apply text-[#e5e5e5] leading-relaxed;
  }

  .prose h1 {
    @apply font-['Syne',sans-serif] font-bold text-3xl text-white mb-2 tracking-tight;
  }

  .prose h2 {
    @apply font-semibold text-xl text-white mt-12 mb-4 pb-2 border-b border-[#1a1a1a];
  }

  .prose h3 {
    @apply font-semibold text-lg text-white mt-8 mb-3;
  }

  .prose p {
    @apply mb-4 text-[#a3a3a3];
  }

  .prose a {
    @apply text-[#c41e3a] hover:underline;
  }

  .prose strong {
    @apply text-white font-medium;
  }

  .prose code {
    @apply font-['JetBrains_Mono',monospace] text-sm bg-[#1a1a1a] px-1.5 py-0.5 rounded text-[#e5e5e5];
  }

  .prose pre {
    @apply font-['JetBrains_Mono',monospace] text-sm bg-[#111] border border-[#1a1a1a] rounded-lg p-4 overflow-x-auto mb-4;
  }

  .prose pre code {
    @apply bg-transparent p-0 rounded-none;
  }

  .prose ul {
    @apply list-disc list-inside mb-4 space-y-1 text-[#a3a3a3];
  }

  .prose ol {
    @apply list-decimal list-inside mb-4 space-y-1 text-[#a3a3a3];
  }

  .prose li {
    @apply pl-1;
  }

  .prose blockquote {
    @apply border-l-2 border-[#262626] pl-4 italic text-[#737373] my-4;
  }

  .prose hr {
    @apply border-[#1a1a1a] my-8;
  }

  .prose img {
    @apply rounded-lg my-6;
  }

  .prose table {
    @apply w-full text-sm mb-4;
  }

  .prose th {
    @apply text-left font-medium text-white pb-2 border-b border-[#262626];
  }

  .prose td {
    @apply py-2 border-b border-[#1a1a1a] text-[#a3a3a3];
  }

  .prose .description {
    @apply text-lg text-[#737373] mb-8;
  }
</style>
